<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google Analytics GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-ZZG5K1EVSV"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag("js", new Date());
    gtag("config", "G-ZZG5K1EVSV", {page_title: 'Iftar Countdown'});
  </script>
  <!-- Vercel Analytics -->
  <script defer src="/_vercel/insights/script.js"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Suhoor & Iftar â€” Noor</title>
  <meta property="og:title" content="Suhoor & Iftar Times ğŸŒ™ â€” Noor">
  <meta property="og:description" content="Accurate Suhoor and Iftar countdown for your location. Ramadan 1447H.">
  <meta property="og:image" content="https://raw.githubusercontent.com/aboladelawal/noor/main/og-noor.png">
  <meta property="og:url" content="https://noor-seven-lac.vercel.app/iftar">
  <meta property="og:type" content="website">
  <meta name="twitter:card" content="summary_large_image">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300;1,400&family=Tajawal:wght@300;400;500&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0a0a0f; --gold: #c9a84c; --gold-light: #e8c97a;
      --gold-dim: #7a6130; --cream: #f5efe0; --text: #e8dcc8; --text-dim: #8a7d6a;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: var(--bg); color: var(--text); font-family: 'Tajawal', sans-serif; min-height: 100vh; overflow-x: hidden; padding-bottom: 60px; }
    body::before {
      content: ''; position: fixed; inset: 0; pointer-events: none; z-index: 0;
      background-image:
        radial-gradient(1px 1px at 15% 20%, rgba(201,168,76,0.5) 0%, transparent 100%),
        radial-gradient(1px 1px at 85% 10%, rgba(201,168,76,0.3) 0%, transparent 100%),
        radial-gradient(1px 1px at 40% 80%, rgba(201,168,76,0.4) 0%, transparent 100%),
        radial-gradient(1px 1px at 70% 60%, rgba(201,168,76,0.25) 0%, transparent 100%),
        radial-gradient(1.5px 1.5px at 10% 55%, rgba(201,168,76,0.35) 0%, transparent 100%),
        radial-gradient(1px 1px at 60% 35%, rgba(201,168,76,0.3) 0%, transparent 100%),
        radial-gradient(1px 1px at 90% 80%, rgba(201,168,76,0.25) 0%, transparent 100%);
    }
    .page { position: relative; z-index: 1; max-width: 480px; margin: 0 auto; padding: 24px 20px 60px; }
    .back { display: inline-flex; align-items: center; gap: 8px; color: var(--text-dim); text-decoration: none; font-size: 13px; margin-bottom: 32px; transition: color 0.2s; }
    .back:hover { color: var(--gold); }
    .header { text-align: center; margin-bottom: 32px; }
    .header-icon { font-size: 48px; margin-bottom: 10px; display: block; }
    .header h1 { font-family: 'Cormorant Garamond', serif; font-size: 42px; font-weight: 300; color: var(--gold-light); line-height: 1; }
    .header-greeting { font-size: 13px; color: var(--gold-dim); margin-top: 6px; font-style: italic; }
    .header p { font-size: 13px; color: var(--text-dim); margin-top: 6px; line-height: 1.6; font-weight: 300; }

    /* Location */
    .location-prompt { text-align: center; padding: 32px 20px; }
    .loc-icon { font-size: 44px; margin-bottom: 16px; }
    .loc-title { font-family: 'Cormorant Garamond', serif; font-size: 28px; color: var(--gold-light); margin-bottom: 10px; }
    .loc-sub { font-size: 13px; color: var(--text-dim); line-height: 1.7; margin-bottom: 28px; }
    .loc-btn { padding: 14px 32px; background: linear-gradient(135deg, var(--gold), #a07828); border: none; border-radius: 12px; color: #0a0a0f; font-size: 15px; font-weight: 600; cursor: pointer; font-family: 'Tajawal', sans-serif; transition: all 0.3s; }
    .loc-btn:hover { transform: translateY(-1px); box-shadow: 0 8px 24px rgba(201,168,76,0.3); }
    .loc-manual { margin-top: 14px; font-size: 12px; color: var(--text-dim); }
    .loc-manual a { color: var(--gold-dim); cursor: pointer; text-decoration: underline; }
    .city-input-wrap { display: none; margin-top: 16px; }
    .city-input-wrap input { width: 100%; background: rgba(255,255,255,0.04); border: 1px solid rgba(201,168,76,0.25); border-radius: 12px; padding: 12px 16px; color: var(--text); font-family: 'Tajawal', sans-serif; font-size: 14px; outline: none; text-align: center; margin-bottom: 10px; }
    .city-input-wrap input:focus { border-color: rgba(201,168,76,0.5); }
    .city-input-wrap button { width: 100%; padding: 12px; background: linear-gradient(135deg, #c9a84c, #a07828); border: none; border-radius: 12px; color: #0a0a0f; font-size: 14px; font-weight: 600; cursor: pointer; font-family: 'Tajawal', sans-serif; }

    /* Main section */
    .main-section { display: none; }
    .location-bar { display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 20px; font-size: 12px; color: var(--text-dim); }
    .location-bar span.city { color: var(--gold-dim); }
    .change-loc { color: var(--gold-dim); cursor: pointer; text-decoration: underline; font-size: 11px; }
    .change-loc:hover { color: var(--gold); }

    /* Next event card */
    .next-card {
      border-radius: 20px;
      padding: 36px 28px;
      text-align: center;
      margin-bottom: 16px;
      position: relative;
      overflow: hidden;
    }
    .next-card.suhoor {
      background: linear-gradient(160deg, #050510 0%, #0d0d2e 40%, #1a1040 100%);
      border: 1px solid rgba(100,100,200,0.25);
    }
    .next-card.iftar {
      background: linear-gradient(160deg, #0d0d1a 0%, #1a0f2e 40%, #2d1810 70%, #1a0a06 100%);
      border: 1px solid rgba(201,168,76,0.25);
    }
    .next-label { font-size: 11px; letter-spacing: 3px; text-transform: uppercase; margin-bottom: 16px; }
    .next-card.suhoor .next-label { color: #6060a0; }
    .next-card.iftar .next-label { color: var(--gold-dim); }
    .countdown-display { font-family: 'Cormorant Garamond', serif; font-size: 72px; font-weight: 300; line-height: 1; letter-spacing: 4px; text-shadow: 0 0 40px currentColor; }
    .next-card.suhoor .countdown-display { color: #a0a0e0; }
    .next-card.iftar .countdown-display { color: var(--gold-light); }
    .time-units { display: flex; justify-content: center; gap: 20px; margin-top: 6px; }
    .time-unit { font-size: 10px; letter-spacing: 2px; color: var(--text-dim); text-transform: uppercase; }
    .next-card.suhoor .time-unit { color: #5050808; }
    .actual-time { margin-top: 18px; font-size: 14px; color: var(--text-dim); }
    .actual-time strong { color: var(--gold); font-weight: 500; }
    .next-card.suhoor .actual-time strong { color: #9090d0; }

    /* Completed state */
    .completed-msg { display: none; text-align: center; padding: 12px 0 8px; }
    .completed-msg .big { font-size: 40px; margin-bottom: 10px; }
    .completed-msg h3 { font-family: 'Cormorant Garamond', serif; font-size: 28px; color: var(--gold-light); margin-bottom: 6px; }
    .completed-msg p { font-size: 13px; color: var(--text-dim); }

    /* Progress bar */
    .fast-progress { margin-bottom: 16px; }
    .fast-progress-labels { display: flex; justify-content: space-between; font-size: 11px; color: var(--text-dim); margin-bottom: 6px; }
    .fast-progress-bar { height: 4px; background: rgba(255,255,255,0.06); border-radius: 2px; overflow: hidden; }
    .fast-progress-fill { height: 100%; background: linear-gradient(90deg, var(--gold-dim), var(--gold)); border-radius: 2px; transition: width 1s linear; }

    /* Dual time card */
    .times-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
    .time-pill {
      background: rgba(255,255,255,0.02);
      border: 1px solid rgba(201,168,76,0.1);
      border-radius: 14px;
      padding: 18px 16px;
      text-align: center;
    }
    .time-pill.active { border-color: rgba(201,168,76,0.3); background: rgba(201,168,76,0.06); }
    .pill-label { font-size: 10px; letter-spacing: 2px; color: var(--text-dim); text-transform: uppercase; margin-bottom: 8px; }
    .pill-time { font-family: 'Cormorant Garamond', serif; font-size: 28px; color: var(--gold); }
    .time-pill.active .pill-time { color: var(--gold-light); }
    .pill-sub { font-size: 11px; color: var(--text-dim); margin-top: 4px; }

    /* Dua card */
    .dua-card { background: rgba(201,168,76,0.04); border: 1px solid rgba(201,168,76,0.12); border-radius: 16px; padding: 24px 20px; margin-bottom: 16px; }
    .dua-label { font-size: 10px; letter-spacing: 3px; color: var(--gold-dim); text-transform: uppercase; margin-bottom: 14px; }
    .dua-arabic { font-family: 'Amiri', serif; font-size: 24px; color: var(--gold-light); text-align: right; direction: rtl; line-height: 1.8; margin-bottom: 12px; }
    .dua-latin { font-size: 13px; color: var(--text); font-style: italic; line-height: 1.7; margin-bottom: 8px; }
    .dua-meaning { font-size: 12px; color: var(--text-dim); line-height: 1.6; }
    .dua-source { font-size: 11px; color: var(--gold-dim); margin-top: 10px; }

    /* Prayer times */
    .prayer-card { background: rgba(255,255,255,0.02); border: 1px solid rgba(201,168,76,0.1); border-radius: 16px; overflow: hidden; margin-bottom: 16px; }
    .prayer-header { padding: 14px 18px; border-bottom: 1px solid rgba(201,168,76,0.08); font-size: 10px; letter-spacing: 3px; color: var(--gold-dim); text-transform: uppercase; }
    .prayer-row { display: flex; justify-content: space-between; align-items: center; padding: 13px 18px; border-bottom: 1px solid rgba(255,255,255,0.02); }
    .prayer-row:last-child { border-bottom: none; }
    .prayer-row.active { background: rgba(201,168,76,0.07); }
    .prayer-name { font-size: 14px; color: var(--text); }
    .prayer-row.active .prayer-name { color: var(--gold-light); font-weight: 500; }
    .prayer-badge { font-size: 9px; letter-spacing: 1px; background: rgba(201,168,76,0.15); color: var(--gold); padding: 2px 8px; border-radius: 10px; margin-left: 8px; }
    .prayer-time { font-family: 'Cormorant Garamond', serif; font-size: 18px; color: var(--gold); }
    .prayer-row.active .prayer-time { color: var(--gold-light); }

    .status-msg { text-align: center; padding: 40px 20px; color: var(--text-dim); font-size: 14px; }
    .error-msg { color: #a06060; }
  </style>
</head>
<body>
  <div class="page">
    <a href="index.html" class="back">â† Back to Noor</a>

    <div class="header">
      <span class="header-icon">ğŸŒ™</span>
      <h1>Suhoor & Iftar</h1>
      <div class="header-greeting" id="header-greeting"></div>
      <p>Live countdown â€” always showing what's next.</p>
    </div>

    <!-- Location prompt -->
    <div id="location-prompt" class="location-prompt">
      <div class="loc-icon">ğŸ“</div>
      <div class="loc-title">Enable Location</div>
      <div class="loc-sub">We need your location to calculate your exact Suhoor and Iftar times.<br>Saved automatically â€” only asked once.</div>
      <button class="loc-btn" onclick="requestLocation()">Allow Location ğŸ“</button>
    </div>

    <!-- Loading -->
    <div id="loading-msg" class="status-msg" style="display:none;">Fetching your prayer times...</div>
    <div id="error-msg" class="status-msg error-msg" style="display:none;"></div>

    <!-- Main section -->
    <div class="main-section" id="main-section">

      <div class="location-bar">
        <span>ğŸ“</span>
        <span class="city" id="city-display">Lagos, Nigeria</span>
        <span class="change-loc" onclick="resetLocation()">change</span>
      </div>

      <!-- Fast progress bar -->
      <div class="fast-progress" id="fast-progress" style="display:none;">
        <div class="fast-progress-labels" id="fast-progress-labels">
          <span>Suhoor ended</span>
          <span id="progress-label">0% fasted</span>
        </div>
        <div class="fast-progress-bar">
          <div class="fast-progress-fill" id="progress-fill" style="width:0%"></div>
        </div>
      </div>

      <!-- Main countdown card -->
      <div class="next-card" id="next-card">
        <div class="next-label" id="next-label">Next</div>
        <div class="countdown-display" id="countdown-display">--:--:--</div>
        <div class="time-units">
          <span class="time-unit">hours</span>
          <span class="time-unit" style="opacity:0">Â·</span>
          <span class="time-unit">minutes</span>
          <span class="time-unit" style="opacity:0">Â·</span>
          <span class="time-unit">seconds</span>
        </div>
        <div class="actual-time"><strong id="next-time-str">--:--</strong></div>
      </div>

      <!-- Completed state overlay -->
      <div class="completed-msg" id="completed-msg">
        <div class="big" id="completed-emoji">ğŸŒ™</div>
        <h3 id="completed-title">Allahu Akbar</h3>
        <p id="completed-sub"></p>
      </div>

      <!-- Suhoor / Iftar time pills -->
      <div class="times-row">
        <div class="time-pill" id="suhoor-pill">
          <div class="pill-label">Suhoor Ends</div>
          <div class="pill-time" id="suhoor-time-display">--:--</div>
          <div class="pill-sub">Fajr begins</div>
        </div>
        <div class="time-pill" id="iftar-pill">
          <div class="pill-label">Iftar</div>
          <div class="pill-time" id="iftar-time-display">--:--</div>
          <div class="pill-sub">Maghrib / Sunset</div>
        </div>
      </div>

      <!-- Active dua (switches based on mode) -->
      <div class="dua-card" id="dua-card"></div>

      <!-- Prayer times -->
      <div class="prayer-card">
        <div class="prayer-header">Today's Prayer Times</div>
        <div id="prayer-list"></div>
      </div>

    </div>
  </div>

  <script>
    // â”€â”€ Greeting â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const savedName = localStorage.getItem('noor_name');
    if (savedName) {
      document.getElementById('header-greeting').textContent = `For you, ${savedName} ğŸŒ™`;
    }

    // â”€â”€ Duas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const DUA_SUHOOR = {
      label: 'Dua for Suhoor (intention)',
      arabic: 'ÙˆÙØ¨ÙØµÙÙˆÙ’Ù…Ù ØºÙØ¯Ù Ù†ÙÙ‘ÙˆÙÙŠÙ’ØªÙ Ù…ÙÙ†Ù’ Ø´ÙÙ‡Ù’Ø±Ù Ø±ÙÙ…ÙØ¶ÙØ§Ù†Ù',
      latin: 'Wa bisawmi ghadin nawaitu min shahri Ramadan',
      meaning: '"I intend to fast tomorrow in the month of Ramadan."',
      source: 'Abu Dawud'
    };
    const DUA_IFTAR = {
      label: 'Dua for Breaking Fast',
      arabic: 'Ø°ÙÙ‡ÙØ¨Ù Ø§Ù„Ø¸ÙÙ‘Ù…ÙØ£Ù ÙˆÙØ§Ø¨Ù’ØªÙÙ„ÙÙ‘ØªÙ Ø§Ù„Ù’Ø¹ÙØ±ÙÙˆÙ‚Ù ÙˆÙØ«ÙØ¨ÙØªÙ Ø§Ù„Ø£ÙØ¬Ù’Ø±Ù Ø¥ÙÙ†Ù’ Ø´ÙØ§Ø¡Ù Ø§Ù„Ù„ÙÙ‘Ù‡',
      latin: "Dhahaba al-áº“ama'u wa ibtallatil-'urÅ«qu wa thabatal-ajru in shÄ'Allah",
      meaning: '"The thirst is gone, the veins are moistened, and the reward is confirmed, if Allah wills."',
      source: 'Sunan Abu Dawud 2357'
    };

    function renderDua(dua) {
      document.getElementById('dua-card').innerHTML = `
        <div class="dua-label">${dua.label}</div>
        <div class="dua-arabic">${dua.arabic}</div>
        <div class="dua-latin">${dua.latin}</div>
        <div class="dua-meaning">${dua.meaning}</div>
        <div class="dua-source">â€” ${dua.source}</div>
      `;
    }

    // â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let prayerData  = null;
    let countdownInterval = null;
    let userCity    = '';

    // â”€â”€ Location â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function requestLocation() {
      document.getElementById('loading-msg').style.display = 'block';
      document.getElementById('loading-msg').textContent = 'Getting your location...';
      document.getElementById('location-prompt').style.display = 'none';
      document.getElementById('error-msg').style.display = 'none';

      if (!navigator.geolocation) {
        showPromptError('Your browser does not support location. Try a different browser.');
        return;
      }

      navigator.geolocation.getCurrentPosition(
        async pos => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          userCity = 'Your Location';

          // Best-effort city name lookup â€” won't block if it fails
          try {
            const r = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`);
            const d = await r.json();
            userCity = [d.address.city || d.address.town || d.address.village || d.address.county, d.address.country].filter(Boolean).join(', ') || 'Your Location';
          } catch { /* keep "Your Location" */ }

          // Save coords immediately
          localStorage.setItem('noor_lat',  lat);
          localStorage.setItem('noor_lng',  lng);
          localStorage.setItem('noor_city', userCity);

          await fetchTimes(lat, lng);
        },
        (err) => {
          const msg = err.code === 1
            ? 'Location permission was denied. Please enable location in your browser settings and try again.'
            : 'Could not get your location. Please try again.';
          showPromptError(msg);
        },
        { timeout: 12000, maximumAge: 300000, enableHighAccuracy: false }
      );
    }

    function showPromptError(msg) {
      document.getElementById('loading-msg').style.display = 'none';
      document.getElementById('location-prompt').style.display = 'block';
      document.getElementById('error-msg').style.display = 'block';
      document.getElementById('error-msg').textContent = msg;
    }

    // â”€â”€ Fetch from Aladhan API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function fetchTimes(lat, lng) {
      document.getElementById('loading-msg').style.display = 'block';
      document.getElementById('loading-msg').textContent = 'Fetching prayer times...';
      try {
        const today = new Date();
        const dd   = String(today.getDate()).padStart(2,'0');
        const mm   = String(today.getMonth()+1).padStart(2,'0');
        const yyyy = today.getFullYear();
        // Aladhan API â€” method 3 = Muslim World League, works globally
        const url = `https://api.aladhan.com/v1/timings/${dd}-${mm}-${yyyy}?latitude=${lat}&longitude=${lng}&method=3`;
        const r = await fetch(url);
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const d = await r.json();
        // Aladhan returns {status:"OK", code:200} or {status:"Error"}
        if (d.status !== 'OK' && d.code !== 200) throw new Error('API returned error: ' + JSON.stringify(d));

        const t = d.data.timings;
        prayerData = {
          fajr:    t.Fajr,
          sunrise: t.Sunrise,
          dhuhr:   t.Dhuhr,
          asr:     t.Asr,
          maghrib: t.Maghrib,
          isha:    t.Isha,
        };

        // Save everything to localStorage
        localStorage.setItem('noor_lat',  lat);
        localStorage.setItem('noor_lng',  lng);
        localStorage.setItem('noor_city', userCity);
        localStorage.setItem('noor_prayer_cache', JSON.stringify({
          date: `${dd}-${mm}-${yyyy}`,
          timings: prayerData
        }));

        document.getElementById('loading-msg').style.display = 'none';
        document.getElementById('error-msg').style.display   = 'none';
        renderMain();

      } catch(e) {
        console.error('fetchTimes error:', e);
        document.getElementById('loading-msg').style.display = 'none';
        const hasSaved = localStorage.getItem('noor_lat');
        document.getElementById('error-msg').style.display = 'block';
        if (hasSaved) {
          document.getElementById('error-msg').innerHTML =
            `Could not load today's times. <a onclick="fetchTimes(${lat}, ${lng})" style="color:var(--gold);cursor:pointer;text-decoration:underline;">Tap to retry</a>`;
        } else {
          document.getElementById('error-msg').innerHTML =
            'Could not fetch prayer times. Check your connection, or enter your city manually.';
          document.getElementById('location-prompt').style.display = 'block';
          showCityInput();
        }
      }
    }

    // â”€â”€ Parse "HH:MM" â†’ today's Date object â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function parseTime(str) {
      const [h, m] = str.split(':').map(Number);
      const d = new Date();
      d.setHours(h, m, 0, 0);
      return d;
    }

    function fmt12(str) {
      const [h, m] = str.split(':').map(Number);
      const ampm = h >= 12 ? 'PM' : 'AM';
      const h12  = h % 12 || 12;
      return `${h12}:${String(m).padStart(2,'0')} ${ampm}`;
    }

    // â”€â”€ Render main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderMain() {
      document.getElementById('city-display').textContent = userCity || 'Your Location';
      document.getElementById('main-section').style.display = 'block';
      gtag('event', 'iftar_loaded', { event_category: 'engagement', event_label: userCity });

      // Time pills
      document.getElementById('suhoor-time-display').textContent = fmt12(prayerData.fajr);
      document.getElementById('iftar-time-display').textContent  = fmt12(prayerData.maghrib);

      // Prayer list
      const prayers = [
        { name: 'Fajr (Suhoor ends)', key: 'fajr'    },
        { name: 'Sunrise',            key: 'sunrise'  },
        { name: 'Dhuhr',              key: 'dhuhr'    },
        { name: 'Asr',                key: 'asr'      },
        { name: 'Maghrib (Iftar)',    key: 'maghrib'  },
        { name: 'Isha',               key: 'isha'     },
      ];
      const now = new Date();
      // Find next prayer
      let nextKey = null;
      for (const p of prayers) {
        if (parseTime(prayerData[p.key]) > now) { nextKey = p.key; break; }
      }
      document.getElementById('prayer-list').innerHTML = prayers.map(p => `
        <div class="prayer-row ${p.key === nextKey ? 'active' : ''}">
          <span class="prayer-name">${p.name}${p.key === nextKey ? '<span class="prayer-badge">NEXT</span>' : ''}</span>
          <span class="prayer-time">${fmt12(prayerData[p.key])}</span>
        </div>
      `).join('');

      if (countdownInterval) clearInterval(countdownInterval);
      tick();
      countdownInterval = setInterval(tick, 1000);
    }

    // â”€â”€ Tick â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function tick() {
      const now     = new Date();
      const fajr    = parseTime(prayerData.fajr);
      const maghrib = parseTime(prayerData.maghrib);
      const nextFajr = new Date(fajr.getTime() + 86400000); // tomorrow fajr

      const card   = document.getElementById('next-card');
      const label  = document.getElementById('next-label');
      const disp   = document.getElementById('countdown-display');
      const timeStr= document.getElementById('next-time-str');
      const compMsg= document.getElementById('completed-msg');
      const progress = document.getElementById('fast-progress');

      // Determine phase
      // Night before fajr: counting down to Suhoor end (fajr)
      // Between fajr and maghrib: fasting â€” count down to iftar
      // After maghrib: fast done â€” count down to tomorrow's suhoor

      let target, mode;

      if (now < fajr) {
        // Before Fajr â€” show suhoor countdown
        mode   = 'suhoor';
        target = fajr;
      } else if (now < maghrib) {
        // Fasting â€” count to Iftar
        mode   = 'iftar';
        target = maghrib;
      } else {
        // After Iftar â€” show next suhoor countdown (next fajr)
        mode   = 'next-suhoor';
        target = nextFajr;
      }

      const diff = Math.max(0, Math.floor((target - now) / 1000));
      const h    = Math.floor(diff / 3600);
      const m    = Math.floor((diff % 3600) / 60);
      const s    = diff % 60;
      const fmt  = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;

      if (mode === 'suhoor') {
        card.className = 'next-card suhoor';
        label.textContent = 'Suhoor ends in';
        disp.textContent  = fmt;
        timeStr.innerHTML = `Fajr at <strong>${fmt12(prayerData.fajr)}</strong>`;
        document.getElementById('suhoor-pill').classList.add('active');
        document.getElementById('iftar-pill').classList.remove('active');
        renderDua(DUA_SUHOOR);
        progress.style.display = 'none';
        compMsg.style.display  = 'none';

      } else if (mode === 'iftar') {
        card.className = 'next-card iftar';
        label.textContent = 'Time Until Iftar';
        disp.textContent  = fmt;
        timeStr.innerHTML = `Iftar at <strong>${fmt12(prayerData.maghrib)}</strong>`;
        document.getElementById('iftar-pill').classList.add('active');
        document.getElementById('suhoor-pill').classList.remove('active');
        renderDua(DUA_IFTAR);
        // Progress bar â€” fasting in progress
        const fastDur = (maghrib - fajr) / 1000;
        const elapsed = (now - fajr) / 1000;
        const pct = Math.min(100, Math.round((elapsed / fastDur) * 100));
        progress.style.display = 'block';
        document.getElementById('fast-progress-labels').innerHTML =
          `<span>ğŸŒ… Fasting in progress</span><span id="progress-label">${pct}% complete</span>`;
        document.getElementById('progress-fill').style.width = pct + '%';
        compMsg.style.display = 'none';

      } else {
        // After Iftar â€” countdown to tomorrow's Suhoor end
        card.className = 'next-card suhoor';
        label.textContent = 'Next Suhoor ends in';
        disp.textContent  = fmt;
        timeStr.innerHTML = `Fajr at <strong>${fmt12(prayerData.fajr)}</strong> tomorrow`;
        document.getElementById('suhoor-pill').classList.remove('active');
        document.getElementById('iftar-pill').classList.remove('active');
        renderDua(DUA_IFTAR);
        // Progress bar â€” fast done, waiting for suhoor
        progress.style.display = 'block';
        document.getElementById('fast-progress-labels').innerHTML =
          `<span>ğŸŒ™ Alhamdulillah â€” fast complete</span><span>Suhoor soon</span>`;
        document.getElementById('progress-fill').style.width = '100%';
        compMsg.style.display = 'none';
      }

      // Update prayer list active state every tick
      const prayers = ['fajr','sunrise','dhuhr','asr','maghrib','isha'];
      let nextKey = null;
      for (const key of prayers) {
        if (parseTime(prayerData[key]) > now) { nextKey = key; break; }
      }
      document.querySelectorAll('.prayer-row').forEach((row, i) => {
        row.classList.toggle('active', prayers[i] === nextKey);
        const badge = row.querySelector('.prayer-badge');
        if (badge) badge.style.display = prayers[i] === nextKey ? 'inline' : 'none';
        if (!badge && prayers[i] === nextKey) {
          row.querySelector('.prayer-name').innerHTML += '<span class="prayer-badge">NEXT</span>';
        }
      });
    }

    // â”€â”€ Reset â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function resetLocation() {
      localStorage.removeItem('noor_lat');
      localStorage.removeItem('noor_lng');
      localStorage.removeItem('noor_city');
      localStorage.removeItem('noor_prayer_cache');
      if (countdownInterval) clearInterval(countdownInterval);
      document.getElementById('main-section').style.display = 'none';
      document.getElementById('location-prompt').style.display = 'block';
    }

    // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const savedLat  = localStorage.getItem('noor_lat');
    const savedLng  = localStorage.getItem('noor_lng');
    const savedCity = localStorage.getItem('noor_city');
    const cache     = localStorage.getItem('noor_prayer_cache');

    if (savedLat && savedLng) {
      // We have a location â€” never show the prompt again
      document.getElementById('location-prompt').style.display = 'none';
      document.getElementById('loading-msg').style.display = 'block';
      userCity = savedCity || 'Your Location';

      if (cache) {
        const c = JSON.parse(cache);
        const today = new Date();
        const todayStr = `${String(today.getDate()).padStart(2,'0')}-${String(today.getMonth()+1).padStart(2,'0')}-${today.getFullYear()}`;
        if (c.date === todayStr) {
          // Cache is fresh â€” use immediately, no network call
          document.getElementById('loading-msg').style.display = 'none';
          prayerData = c.timings;
          renderMain();
        } else {
          // New day â€” silently refetch in background
          fetchTimes(parseFloat(savedLat), parseFloat(savedLng));
        }
      } else {
        // No cache yet â€” fetch
        fetchTimes(parseFloat(savedLat), parseFloat(savedLng));
      }
    }
    // else: no saved location â€” location-prompt stays visible (default)
  </script>
</body>
</html>
